---
/**
 * CodeBlock Component
 *
 * Displays code with syntax highlighting and copy-to-clipboard button.
 * Used for command examples and code snippets in documentation.
 *
 * Feature Slice 21: Documentation Page
 */
interface Props {
  code: string;
  language?: string;
  filename?: string;
  class?: string;
}

const { code, language = 'bash', filename, class: className } = Astro.props;
---

<div class:list={['code-block group relative', className]} data-testid="code-block">
  {/* Header with filename and copy button */}
  <div class="flex items-center justify-between rounded-t-lg bg-surface-3 px-4 py-2">
    <div class="flex items-center gap-2">
      {/* Terminal dots */}
      <div class="flex gap-1.5">
        <span class="h-3 w-3 rounded-full bg-red-400/60"></span>
        <span class="h-3 w-3 rounded-full bg-yellow-400/60"></span>
        <span class="h-3 w-3 rounded-full bg-green-400/60"></span>
      </div>
      {filename && (
        <span class="ml-2 text-xs text-muted-foreground" data-testid="code-block-filename">
          {filename}
        </span>
      )}
    </div>
    <button
      type="button"
      class="copy-button flex items-center gap-1.5 rounded px-2 py-1 text-xs text-muted-foreground transition-colors hover:bg-surface-2 hover:text-foreground"
      data-code={code}
      data-testid="code-block-copy"
      aria-label="Copy code to clipboard"
    >
      <svg
        class="copy-icon h-4 w-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
        />
      </svg>
      <svg
        class="check-icon hidden h-4 w-4 text-green-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 13l4 4L19 7"
        />
      </svg>
      <span class="copy-text">Copy</span>
    </button>
  </div>

  {/* Code content */}
  <pre class="!mt-0 !rounded-t-none"><code class={`language-${language}`} data-testid="code-block-code">{code}</code></pre>
</div>

<script>
  // Copy to clipboard functionality
  document.querySelectorAll('.copy-button').forEach((button) => {
    button.addEventListener('click', async () => {
      const code = button.getAttribute('data-code');
      if (!code) return;

      try {
        await navigator.clipboard.writeText(code);

        // Update button UI
        const copyIcon = button.querySelector('.copy-icon');
        const checkIcon = button.querySelector('.check-icon');
        const copyText = button.querySelector('.copy-text');

        if (copyIcon && checkIcon && copyText) {
          copyIcon.classList.add('hidden');
          checkIcon.classList.remove('hidden');
          copyText.textContent = 'Copied!';

          // Reset after 2 seconds
          setTimeout(() => {
            copyIcon.classList.remove('hidden');
            checkIcon.classList.add('hidden');
            copyText.textContent = 'Copy';
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy code:', err);
      }
    });
  });
</script>

<style>
  .code-block pre {
    margin-top: 0;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }
</style>
