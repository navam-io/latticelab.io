---
/**
 * Stripe Buy Button Component
 *
 * Wraps the Stripe Buy Button element with:
 * - Environment variable configuration
 * - Development placeholder mode
 * - Loading state handling
 * - Consistent styling wrapper
 *
 * Feature Slice 31: Stripe Buy Button Integration
 *
 * Usage:
 *   <StripeBuyButton />
 *   <StripeBuyButton size="sm" />
 *   <StripeBuyButton showPrice={false} />
 *
 * Environment Variables:
 *   PUBLIC_STRIPE_BUY_BUTTON_ID - Stripe Buy Button ID
 *   PUBLIC_STRIPE_PUBLISHABLE_KEY - Stripe Publishable Key
 *
 * When env vars are not set, displays a styled placeholder button
 * that links to /pricing for development/preview.
 */

interface Props {
  /** Button size variant */
  size?: 'sm' | 'md' | 'lg';
  /** Show price on placeholder button */
  showPrice?: boolean;
  /** Custom class for the wrapper */
  class?: string;
  /** Test ID for testing */
  'data-testid'?: string;
}

const {
  size = 'lg',
  showPrice = true,
  class: className = '',
  'data-testid': testId = 'stripe-buy-button',
} = Astro.props;

// Get environment variables
const buyButtonId = import.meta.env.PUBLIC_STRIPE_BUY_BUTTON_ID || '';
const publishableKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY || '';

// Determine if Stripe is configured
const isStripeConfigured = buyButtonId && publishableKey;

// Size classes for the placeholder button
const sizeClasses = {
  sm: 'py-2 px-4 text-sm',
  md: 'py-3 px-6 text-base',
  lg: 'py-4 px-8 text-lg',
};

const buttonSize = sizeClasses[size];
---

<div
  class={`stripe-buy-button-wrapper ${className}`}
  data-testid={testId}
  data-stripe-configured={isStripeConfigured.toString()}
>
  {isStripeConfigured ? (
    <!-- Real Stripe Buy Button -->
    <div class="stripe-button-container" data-testid={`${testId}-stripe`}>
      <stripe-buy-button
        buy-button-id={buyButtonId}
        publishable-key={publishableKey}
      >
      </stripe-buy-button>
    </div>
  ) : (
    <!-- Placeholder Button for Development -->
    <a
      href="/pricing"
      class={`stripe-placeholder-button inline-flex w-full items-center justify-center gap-2 rounded-lg bg-accent font-semibold text-accent-foreground transition-all duration-200 hover:bg-accent/90 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 focus-visible:ring-offset-background ${buttonSize}`}
      data-testid={`${testId}-placeholder`}
      data-track="buy"
      data-track-value="99"
    >
      <svg
        class="h-5 w-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
        />
      </svg>
      <span>
        {showPrice ? 'Get Lattice for $99' : 'Get Lattice Now'}
      </span>
    </a>
    <p class="mt-2 text-center text-xs text-muted-foreground" data-testid={`${testId}-placeholder-note`}>
      Stripe integration pending configuration
    </p>
  )}
</div>

<style>
  .stripe-buy-button-wrapper {
    width: 100%;
  }

  .stripe-button-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 48px;
  }

  /* Style the Stripe button container */
  .stripe-button-container stripe-buy-button {
    width: 100%;
  }

  /* Loading state before Stripe loads */
  .stripe-button-container:has(stripe-buy-button:not([loaded])) {
    position: relative;
  }

  .stripe-button-container:has(stripe-buy-button:not([loaded]))::after {
    content: 'Loading checkout...';
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface-2);
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-muted-foreground);
  }

  /* Placeholder button hover effect */
  .stripe-placeholder-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .stripe-placeholder-button:active {
    transform: translateY(0);
  }
</style>
