---
/**
 * Feature Detail Page (Dynamic Route)
 *
 * Renders individual feature pages from MDX content collection.
 * Each page includes hero, description, use cases, interactive preview, and CTA.
 *
 * Feature Slice 17: Feature Detail Pages
 * Feature Slice 29: Integrate Previews into Feature Pages
 */
import { getCollection, type CollectionEntry } from 'astro:content';
import PageLayout from '@/layouts/PageLayout.astro';
import Section from '@/components/ui/Section.astro';
import Container from '@/components/ui/Container.astro';
import Card from '@/components/ui/Card.astro';
import Button from '@/components/ui/Button.astro';
import TryItSection from '@/components/sections/TryItSection.astro';

export async function getStaticPaths() {
  const features = await getCollection('features');
  return features.map((feature) => ({
    params: { slug: feature.slug },
    props: { feature },
  }));
}

interface Props {
  feature: CollectionEntry<'features'>;
}

const { feature } = Astro.props;
const { Content } = await feature.render();
const { title, subtitle, description, color, highlights, useCases, screenshot } = feature.data;

// Color mapping for consistent styling
const colorClasses = {
  blue: {
    bg: 'bg-blue-100',
    text: 'text-blue-600',
    accent: 'text-blue-500',
    border: 'border-blue-200',
    light: 'bg-blue-50',
  },
  purple: {
    bg: 'bg-purple-100',
    text: 'text-purple-600',
    accent: 'text-purple-500',
    border: 'border-purple-200',
    light: 'bg-purple-50',
  },
  green: {
    bg: 'bg-green-100',
    text: 'text-green-600',
    accent: 'text-green-500',
    border: 'border-green-200',
    light: 'bg-green-50',
  },
  orange: {
    bg: 'bg-orange-100',
    text: 'text-orange-600',
    accent: 'text-orange-500',
    border: 'border-orange-200',
    light: 'bg-orange-50',
  },
};

const colors = colorClasses[color];

// Icon SVG paths
const iconPaths: Record<string, string> = {
  database: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4',
  brain: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z',
  'file-output': 'M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
  layers: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10',
};

const iconPath = iconPaths[feature.data.icon || 'database'];

// Preview configuration for features with interactive demos
const previewConfig: Record<string, { headline: string; description: string }> = {
  lab: {
    headline: 'Try the Chat Interface',
    description: 'Experience how Lattice Lab\'s AI chat works. Type a message and see streaming responses with source citations.',
  },
  sources: {
    headline: 'Explore Source Management',
    description: 'See how easy it is to add, search, and organize your knowledge sources. Try the upload simulation and browse blueprints.',
  },
  scenarios: {
    headline: 'Configure Your AI Stack',
    description: 'Select your workload type, set performance targets, and get AI-powered stack recommendations tailored to your needs.',
  },
};

// Check if this feature has an interactive preview
const hasPreview = feature.slug in previewConfig;
const previewSettings = previewConfig[feature.slug];
---

<PageLayout
  title={`${title} - Lattice Lab Features`}
  description={description}
>
  <!-- Hero Section -->
  <Section spacing="lg" background="default" data-testid="feature-detail-hero">
    <Container size="lg">
      <div class="mx-auto max-w-3xl text-center">
        <!-- Feature Icon -->
        <div
          class={`mx-auto mb-6 flex h-20 w-20 items-center justify-center rounded-2xl ${colors.bg}`}
          data-testid="feature-detail-icon"
        >
          <svg
            class={`h-10 w-10 ${colors.text}`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d={iconPath}
            />
          </svg>
        </div>

        <!-- Subtitle -->
        <span
          class={`mb-2 inline-block text-sm font-medium ${colors.text}`}
          data-testid="feature-detail-subtitle"
        >
          {subtitle}
        </span>

        <!-- Title -->
        <h1
          class="mb-4 text-4xl font-bold tracking-tight text-foreground sm:text-5xl"
          data-testid="feature-detail-title"
        >
          {title}
        </h1>

        <!-- Description -->
        <p
          class="text-xl text-muted-foreground"
          data-testid="feature-detail-description"
        >
          {description}
        </p>
      </div>
    </Container>
  </Section>

  <!-- Highlights Section -->
  {highlights && highlights.length > 0 && (
    <Section spacing="md" background="muted" data-testid="feature-detail-highlights">
      <Container size="lg">
        <div class="mx-auto max-w-4xl">
          <h2
            class="mb-8 text-center text-2xl font-bold tracking-tight text-foreground"
            data-testid="feature-detail-highlights-title"
          >
            Key Capabilities
          </h2>
          <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3" data-testid="feature-detail-highlights-grid">
            {highlights.map((highlight, index) => (
              <div
                class={`flex items-start gap-3 rounded-lg border ${colors.border} ${colors.light} p-4`}
                data-testid={`feature-detail-highlight-${index}`}
              >
                <svg
                  class={`h-5 w-5 flex-shrink-0 ${colors.accent}`}
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <span class="text-sm text-foreground">{highlight}</span>
              </div>
            ))}
          </div>
        </div>
      </Container>
    </Section>
  )}

  <!-- Interactive Preview or Screenshot Placeholder Section -->
  {hasPreview ? (
    <TryItSection
      headline={previewSettings.headline}
      description={previewSettings.description}
      featureSlug={feature.slug}
      colorScheme={color}
    />
  ) : (
    <Section spacing="lg" background="default" data-testid="feature-detail-screenshot">
      <Container size="lg">
        <div class="mx-auto max-w-4xl">
          <div
            class={`aspect-video overflow-hidden rounded-xl border-2 ${colors.border} ${colors.light} flex items-center justify-center`}
            data-testid="feature-detail-screenshot-placeholder"
          >
            <div class="text-center">
              <svg
                class={`mx-auto h-16 w-16 ${colors.accent} opacity-50`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
              <p class="mt-4 text-sm text-muted-foreground">
                Product screenshot coming soon
              </p>
            </div>
          </div>
        </div>
      </Container>
    </Section>
  )}

  <!-- Use Cases Section -->
  {useCases && useCases.length > 0 && (
    <Section spacing="lg" background="muted" data-testid="feature-detail-usecases">
      <Container size="lg">
        <div class="mx-auto max-w-4xl">
          <h2
            class="mb-8 text-center text-2xl font-bold tracking-tight text-foreground"
            data-testid="feature-detail-usecases-title"
          >
            Use Cases by Persona
          </h2>
          <div class="grid gap-6 sm:grid-cols-3" data-testid="feature-detail-usecases-grid">
            {useCases.map((useCase, index) => (
              <Card padding="md" class="h-full" data-testid={`feature-detail-usecase-${index}`}>
                <div class={`mb-3 inline-block rounded-full ${colors.bg} px-3 py-1 text-xs font-medium ${colors.text}`} data-testid={`feature-detail-usecase-${index}-persona`}>
                  {useCase.persona}
                </div>
                <h3 class="mb-2 font-semibold text-foreground" data-testid={`feature-detail-usecase-${index}-title`}>
                  {useCase.title}
                </h3>
                <p class="text-sm text-muted-foreground" data-testid={`feature-detail-usecase-${index}-description`}>
                  {useCase.description}
                </p>
              </Card>
            ))}
          </div>
        </div>
      </Container>
    </Section>
  )}

  <!-- MDX Content Section -->
  <Section spacing="lg" background="default" data-testid="feature-detail-content">
    <Container size="md">
      <div class="prose prose-lg mx-auto max-w-none" data-testid="feature-detail-prose">
        <Content />
      </div>
    </Container>
  </Section>

  <!-- CTA Section -->
  <Section spacing="lg" background="muted" data-testid="feature-detail-cta">
    <Container size="md">
      <div class="text-center">
        <h2
          class="mb-4 text-2xl font-bold tracking-tight text-foreground sm:text-3xl"
          data-testid="feature-detail-cta-headline"
        >
          Ready to Try {title}?
        </h2>
        <p
          class="mb-8 text-lg text-muted-foreground"
          data-testid="feature-detail-cta-subhead"
        >
          Get lifetime access to all Lattice Lab features for just $99.
        </p>
        <div class="flex flex-col items-center gap-4 sm:flex-row sm:justify-center" data-testid="feature-detail-cta-buttons">
          <Button
            variant="primary"
            size="lg"
            href="/pricing"
            class="w-full px-8 sm:w-auto"
            data-testid="feature-detail-cta-primary"
          >
            Get Lattice for $99
          </Button>
          <Button
            variant="secondary"
            size="lg"
            href="/features"
            class="w-full px-8 sm:w-auto"
            data-testid="feature-detail-cta-secondary"
          >
            View All Features
          </Button>
        </div>
        <p class="mt-6 text-sm text-muted-foreground" data-testid="feature-detail-cta-trust">
          30-day money-back guarantee. Self-hosted for privacy.
        </p>
      </div>
    </Container>
  </Section>
</PageLayout>

<style>
  /* Prose styling for MDX content */
  .prose {
    color: var(--color-foreground);
  }
  .prose :global(h2) {
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.025em;
    color: var(--color-foreground);
  }
  .prose :global(h3) {
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-foreground);
  }
  .prose :global(h4) {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-foreground);
  }
  .prose :global(p) {
    margin-bottom: 1rem;
    color: var(--color-muted-foreground);
    line-height: 1.75;
  }
  .prose :global(ul) {
    margin-bottom: 1rem;
    list-style-type: disc;
    padding-left: 1.5rem;
  }
  .prose :global(ol) {
    margin-bottom: 1rem;
    list-style-type: decimal;
    padding-left: 1.5rem;
  }
  .prose :global(li) {
    margin-bottom: 0.5rem;
    color: var(--color-muted-foreground);
  }
  .prose :global(blockquote) {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid var(--color-accent);
    padding-left: 1rem;
    font-style: italic;
    color: var(--color-muted-foreground);
  }
  .prose :global(code) {
    border-radius: 0.25rem;
    background-color: var(--color-surface-2);
    padding: 0.125rem 0.375rem;
    font-size: 0.875rem;
    font-family: var(--font-mono);
  }
  .prose :global(pre) {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    overflow-x: auto;
    border-radius: 0.5rem;
    background-color: var(--color-surface-2);
    padding: 1rem;
  }
  .prose :global(pre code) {
    background-color: transparent;
    padding: 0;
  }
  .prose :global(table) {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
    border-collapse: collapse;
  }
  .prose :global(th) {
    border: 1px solid var(--color-border);
    background-color: var(--color-surface-2);
    padding: 0.5rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--color-foreground);
  }
  .prose :global(td) {
    border: 1px solid var(--color-border);
    padding: 0.5rem 1rem;
    color: var(--color-muted-foreground);
  }
  .prose :global(a) {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 4px;
  }
  .prose :global(a:hover) {
    opacity: 0.8;
  }
  .prose :global(strong) {
    font-weight: 600;
    color: var(--color-foreground);
  }
</style>
