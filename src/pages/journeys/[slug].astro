---
/**
 * Journey Detail Page (Dynamic Route)
 *
 * Renders individual journey pages from MDX content collection.
 * Each page includes hero with JTBD statement, step-by-step guide,
 * and additional MDX content.
 *
 * Feature Slice 19: Journey Detail Pages
 */
import { getCollection, type CollectionEntry } from 'astro:content';
import PageLayout from '@/layouts/PageLayout.astro';
import Section from '@/components/ui/Section.astro';
import Container from '@/components/ui/Container.astro';
import Card from '@/components/ui/Card.astro';
import Button from '@/components/ui/Button.astro';

export async function getStaticPaths() {
  const journeys = await getCollection('journeys');
  return journeys.map((journey) => ({
    params: { slug: journey.slug },
    props: { journey },
  }));
}

interface Props {
  journey: CollectionEntry<'journeys'>;
}

const { journey } = Astro.props;
const { Content } = await journey.render();
const { title, description, jtbd, category, estimatedTime, steps } = journey.data;

// Get all journeys for navigation
const allJourneys = await getCollection('journeys');
const sortedJourneys = allJourneys.sort((a, b) => a.data.order - b.data.order);
const currentIndex = sortedJourneys.findIndex((j) => j.slug === journey.slug);
const prevJourney = currentIndex > 0 ? sortedJourneys[currentIndex - 1] : null;
const nextJourney = currentIndex < sortedJourneys.length - 1 ? sortedJourneys[currentIndex + 1] : null;

// Category icon mapping
const categoryIcons: Record<string, string> = {
  'Getting Started': 'M13 10V3L4 14h7v7l9-11h-7z',
  'Configuration': 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z',
  'Sources': 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4',
};
---

<PageLayout
  title={`${title} - Product Journey - Lattice Lab`}
  description={description}
>
  <!-- Hero Section -->
  <Section spacing="lg" background="default" data-testid="journey-detail-hero">
    <Container size="lg">
      <div class="mx-auto max-w-3xl">
        <!-- Breadcrumb -->
        <nav class="mb-6" aria-label="Breadcrumb" data-testid="journey-detail-breadcrumb">
          <ol class="flex items-center gap-2 text-sm text-muted-foreground">
            <li>
              <a href="/journeys" class="hover:text-foreground transition-colors">
                Journeys
              </a>
            </li>
            <li aria-hidden="true">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </li>
            <li>
              <span class="text-foreground">{title}</span>
            </li>
          </ol>
        </nav>

        <!-- Category Badge -->
        <div class="mb-4 flex items-center gap-2" data-testid="journey-detail-category">
          <span class="inline-flex items-center gap-1.5 rounded-full bg-accent/10 px-3 py-1 text-sm font-medium text-accent">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={categoryIcons[category]} />
            </svg>
            {category}
          </span>
          <span class="text-sm text-muted-foreground" data-testid="journey-detail-time">
            {estimatedTime}
          </span>
        </div>

        <!-- Title -->
        <h1
          class="mb-4 text-4xl font-bold tracking-tight text-foreground sm:text-5xl"
          data-testid="journey-detail-title"
        >
          {title}
        </h1>

        <!-- Description -->
        <p
          class="mb-6 text-xl text-muted-foreground"
          data-testid="journey-detail-description"
        >
          {description}
        </p>

        <!-- JTBD Statement -->
        <div
          class="rounded-lg border border-accent/20 bg-accent/5 p-4"
          data-testid="journey-detail-jtbd"
        >
          <p class="text-sm italic text-muted-foreground">
            "{jtbd}"
          </p>
        </div>
      </div>
    </Container>
  </Section>

  <!-- Steps Section -->
  <Section spacing="lg" background="muted" data-testid="journey-detail-steps">
    <Container size="lg">
      <div class="mx-auto max-w-3xl">
        <h2
          class="mb-8 text-2xl font-bold tracking-tight text-foreground"
          data-testid="journey-detail-steps-title"
        >
          Step-by-Step Guide
        </h2>

        <div class="space-y-6" data-testid="journey-detail-steps-list">
          {steps.map((step, index) => (
            <div
              class="relative"
              data-testid={`journey-step-${index}`}
            >
              {/* Connector line */}
              {index < steps.length - 1 && (
                <div class="absolute left-6 top-14 bottom-0 w-0.5 bg-border" aria-hidden="true" />
              )}

              <Card padding="md" class="relative">
                <div class="flex gap-4">
                  {/* Step number */}
                  <div
                    class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-accent text-lg font-bold text-white"
                    data-testid={`journey-step-${index}-number`}
                  >
                    {index + 1}
                  </div>

                  <div class="flex-1">
                    {/* Step title */}
                    <h3
                      class="mb-2 text-lg font-semibold text-foreground"
                      data-testid={`journey-step-${index}-title`}
                    >
                      {step.title}
                    </h3>

                    {/* Step description */}
                    <p
                      class="text-muted-foreground"
                      data-testid={`journey-step-${index}-description`}
                    >
                      {step.description}
                    </p>

                    {/* Tip (if present) */}
                    {step.tip && (
                      <div
                        class="mt-4 flex items-start gap-2 rounded-lg bg-surface-2 p-3"
                        data-testid={`journey-step-${index}-tip`}
                      >
                        <svg
                          class="h-5 w-5 flex-shrink-0 text-accent"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                          />
                        </svg>
                        <p class="text-sm text-muted-foreground">
                          <span class="font-medium text-foreground">Tip:</span> {step.tip}
                        </p>
                      </div>
                    )}

                    {/* Screenshot placeholder */}
                    <div
                      class="mt-4 aspect-video overflow-hidden rounded-lg bg-surface-2 flex items-center justify-center"
                      data-testid={`journey-step-${index}-screenshot`}
                    >
                      <div class="text-center">
                        <svg
                          class="mx-auto h-12 w-12 text-muted-foreground/30"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="1.5"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                          />
                        </svg>
                        <p class="mt-2 text-xs text-muted-foreground">
                          Screenshot coming soon
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </Card>
            </div>
          ))}
        </div>
      </div>
    </Container>
  </Section>

  <!-- MDX Content Section -->
  <Section spacing="lg" background="default" data-testid="journey-detail-content">
    <Container size="md">
      <div class="prose prose-lg mx-auto max-w-none" data-testid="journey-detail-prose">
        <Content />
      </div>
    </Container>
  </Section>

  <!-- Navigation Section -->
  <Section spacing="md" background="muted" data-testid="journey-detail-nav">
    <Container size="lg">
      <div class="mx-auto max-w-3xl">
        <div class="flex items-center justify-between gap-4" data-testid="journey-detail-nav-links">
          {/* Previous Journey */}
          <div class="flex-1">
            {prevJourney && (
              <a
                href={`/journeys/${prevJourney.slug}`}
                class="group flex items-center gap-3 rounded-lg border border-border bg-background p-4 transition-colors hover:border-accent"
                data-testid="journey-detail-nav-prev"
              >
                <svg
                  class="h-5 w-5 text-muted-foreground transition-transform group-hover:-translate-x-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <div>
                  <div class="text-xs text-muted-foreground">Previous</div>
                  <div class="font-medium text-foreground">{prevJourney.data.title}</div>
                </div>
              </a>
            )}
          </div>

          {/* Back to Journeys */}
          <a
            href="/journeys"
            class="flex items-center gap-2 text-sm font-medium text-accent hover:text-accent/80 transition-colors"
            data-testid="journey-detail-nav-back"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
            All Journeys
          </a>

          {/* Next Journey */}
          <div class="flex-1 flex justify-end">
            {nextJourney && (
              <a
                href={`/journeys/${nextJourney.slug}`}
                class="group flex items-center gap-3 rounded-lg border border-border bg-background p-4 transition-colors hover:border-accent text-right"
                data-testid="journey-detail-nav-next"
              >
                <div>
                  <div class="text-xs text-muted-foreground">Next</div>
                  <div class="font-medium text-foreground">{nextJourney.data.title}</div>
                </div>
                <svg
                  class="h-5 w-5 text-muted-foreground transition-transform group-hover:translate-x-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>
    </Container>
  </Section>

  <!-- CTA Section -->
  <Section spacing="lg" background="default" data-testid="journey-detail-cta">
    <Container size="md">
      <div class="text-center">
        <h2
          class="mb-4 text-2xl font-bold tracking-tight text-foreground sm:text-3xl"
          data-testid="journey-detail-cta-headline"
        >
          Ready to Try This Journey?
        </h2>
        <p
          class="mb-8 text-lg text-muted-foreground"
          data-testid="journey-detail-cta-subhead"
        >
          Get Lattice Lab and follow along in your own workspace.
        </p>
        <div class="flex flex-col items-center gap-4 sm:flex-row sm:justify-center" data-testid="journey-detail-cta-buttons">
          <Button
            variant="primary"
            size="lg"
            href="/pricing"
            class="w-full px-8 sm:w-auto"
            data-testid="journey-detail-cta-primary"
          >
            Get Lattice for $99
          </Button>
          <Button
            variant="secondary"
            size="lg"
            href="/journeys"
            class="w-full px-8 sm:w-auto"
            data-testid="journey-detail-cta-secondary"
          >
            Browse All Journeys
          </Button>
        </div>
        <p class="mt-6 text-sm text-muted-foreground" data-testid="journey-detail-cta-trust">
          30-day money-back guarantee. Self-hosted for privacy.
        </p>
      </div>
    </Container>
  </Section>
</PageLayout>

<style>
  /* Prose styling for MDX content */
  .prose {
    color: var(--color-foreground);
  }
  .prose :global(h2) {
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.025em;
    color: var(--color-foreground);
  }
  .prose :global(h3) {
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-foreground);
  }
  .prose :global(h4) {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-foreground);
  }
  .prose :global(p) {
    margin-bottom: 1rem;
    color: var(--color-muted-foreground);
    line-height: 1.75;
  }
  .prose :global(ul) {
    margin-bottom: 1rem;
    list-style-type: disc;
    padding-left: 1.5rem;
  }
  .prose :global(ol) {
    margin-bottom: 1rem;
    list-style-type: decimal;
    padding-left: 1.5rem;
  }
  .prose :global(li) {
    margin-bottom: 0.5rem;
    color: var(--color-muted-foreground);
  }
  .prose :global(blockquote) {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid var(--color-accent);
    padding-left: 1rem;
    font-style: italic;
    color: var(--color-muted-foreground);
  }
  .prose :global(code) {
    border-radius: 0.25rem;
    background-color: var(--color-surface-2);
    padding: 0.125rem 0.375rem;
    font-size: 0.875rem;
    font-family: var(--font-mono);
  }
  .prose :global(pre) {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    overflow-x: auto;
    border-radius: 0.5rem;
    background-color: var(--color-surface-2);
    padding: 1rem;
  }
  .prose :global(pre code) {
    background-color: transparent;
    padding: 0;
  }
  .prose :global(table) {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
    border-collapse: collapse;
  }
  .prose :global(th) {
    border: 1px solid var(--color-border);
    background-color: var(--color-surface-2);
    padding: 0.5rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--color-foreground);
  }
  .prose :global(td) {
    border: 1px solid var(--color-border);
    padding: 0.5rem 1rem;
    color: var(--color-muted-foreground);
  }
  .prose :global(a) {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 4px;
  }
  .prose :global(a:hover) {
    opacity: 0.8;
  }
  .prose :global(strong) {
    font-weight: 600;
    color: var(--color-foreground);
  }
</style>
