---
/**
 * Dynamic Tool Page
 * Renders individual tool pages matching feature page design
 */
import Layout from '@layouts/Layout.astro';
import Header from '@components/Header.vue';
import Footer from '@components/Footer.vue';
import StickyNav from '@components/features/StickyNav.vue';
import FeatureHero from '@components/features/FeatureHero.vue';
import CapabilitySection from '@components/features/CapabilitySection.vue';
import TechSpecs from '@components/features/TechSpecs.vue';
import RelatedContent from '@components/features/RelatedContent.vue';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const tools = await getCollection('tools');
  return tools.map((tool) => ({
    params: { tool: tool.slug },
    props: { tool },
  }));
}

const { tool } = Astro.props;
const { Content } = await tool.render();

// Get related tools (same category, excluding current)
const allTools = await getCollection('tools');
const relatedTools = allTools
  .filter(t => t.data.category === tool.data.category && t.slug !== tool.slug)
  .slice(0, 2);

// Navigation items
const navItems = [
  { id: 'overview', label: 'Overview' },
  { id: 'capabilities', label: 'Capabilities' },
  { id: 'specs', label: 'Specifications' },
  { id: 'resources', label: 'Resources' }
];

// Color scheme mapping for categories
// Valid options: 'violet' | 'blue' | 'teal' | 'amber' | 'rose'
const categoryColors: Record<string, string> = {
  calculator: 'blue',
  advisor: 'teal',
  registry: 'violet',
  data: 'teal'
};

const colorScheme = categoryColors[tool.data.category || 'calculator'] as 'violet' | 'blue' | 'teal' | 'amber' | 'rose';

// Tool-specific taglines
const toolTaglines: Record<string, string> = {
  'memory-calculator': 'Estimate Plan Optimize',
  'tco-calculator': 'Compare Analyze Save',
  'model-registry': 'Browse Compare Select',
  'accelerator-registry': 'Browse Filter Select',
  'parallelism-advisor': 'Configure Scale Distribute',
  'quantization-advisor': 'Compress Optimize Deploy',
  'spot-advisor': 'Track Save Schedule',
  'live-data-feeds': 'Sync Update Monitor'
};

// Parse features into capability groups (first 3 features for each capability)
const features = tool.data.features || [];
const capabilityGroups = [
  features.slice(0, 3),
  features.slice(3, 6)
].filter(g => g.length > 0);

// Format features with strong tags
const formatFeature = (feature: string) => {
  // Bold the first part before any colon or dash
  if (feature.includes(':')) {
    const [first, ...rest] = feature.split(':');
    return `<strong>${first}:</strong>${rest.join(':')}`;
  }
  return feature;
};

// Icon paths
const icons = {
  calculator: 'M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z',
  advisor: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z',
  registry: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4',
  framework: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4',
  document: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
  cloud: 'M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z',
  database: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4'
};

const categoryIcon = {
  calculator: icons.calculator,
  advisor: icons.advisor,
  registry: icons.registry,
  framework: icons.framework
}[tool.data.category || 'calculator'];

// Build tech specs from content
const techSpecs = [
  {
    category: 'Key Features',
    icon: categoryIcon,
    color: colorScheme,
    items: features.slice(0, 4).map(formatFeature)
  },
  {
    category: 'Capabilities',
    icon: icons.database,
    color: 'blue',
    items: features.slice(4, 8).length > 0 ? features.slice(4, 8).map(formatFeature) : features.slice(0, 4).map(formatFeature)
  }
];

// Related content - journeys and docs
const journeys = tool.data.journeyLink ? [
  {
    title: `${tool.data.name} Journey`,
    description: `Learn how to use ${tool.data.name} effectively`,
    href: tool.data.journeyLink
  }
] : [];

const docs = tool.data.docsLink ? [
  {
    title: `${tool.data.name} Documentation`,
    description: `Complete guide to ${tool.data.name}`,
    href: tool.data.docsLink
  }
] : [];

// Add related tools as additional journeys
relatedTools.forEach(rt => {
  journeys.push({
    title: rt.data.name,
    description: rt.data.shortDescription || rt.data.description.slice(0, 80) + '...',
    href: `/tools/${rt.slug}`
  });
});
---

<Layout
  title={tool.data.seoTitle || `${tool.data.name} - Lattice Tools`}
  description={tool.data.seoDescription || tool.data.description}
  keywords={`${tool.data.name}, AI tools, ${tool.data.category}, infrastructure planning, Lattice`}
>
  <Header client:load />

  <main data-testid={`tool-page-${tool.slug}`}>
    <!-- Sticky Navigation -->
    <StickyNav
      client:load
      featureName={tool.data.name}
      navItems={navItems}
      buyButtonText="Get Lattice"
      buyButtonHref="/#pricing"
      testId={`${tool.slug}-nav`}
    />

    <!-- Hero Section -->
    <section id="overview">
      <FeatureHero
        client:load
        headline={tool.data.name}
        tagline={toolTaglines[tool.slug] || 'Smart AI Infrastructure'}
        description={tool.data.description}
        productImage={tool.data.productImage}
        productImageAlt={tool.data.productImageAlt || `${tool.data.name} screenshot`}
        browserUrl={`lattice.app/tools/${tool.slug}`}
        colorScheme={colorScheme}
        primaryCTA="Get Lattice"
        primaryHref="/#pricing"
        secondaryCTA={tool.data.docsLink ? "View docs" : undefined}
        secondaryHref={tool.data.docsLink}
        testId={`${tool.slug}-hero`}
      />
    </section>

    <!-- Capabilities Section -->
    <section id="capabilities">
      {capabilityGroups.length > 0 && (
        <CapabilitySection
          client:load
          title="Key Capabilities"
          description={`What ${tool.data.name} helps you accomplish.`}
          features={capabilityGroups[0].map(formatFeature)}
          image={tool.data.productImage}
          imageAlt={tool.data.productImageAlt || `${tool.data.name} interface`}
          icon={categoryIcon}
          iconColor={colorScheme}
          imagePosition="left"
          background="white"
          showBrowserFrame={true}
          testId={`${tool.slug}-capabilities-1`}
        />
      )}

      {capabilityGroups.length > 1 && (
        <CapabilitySection
          client:load
          title="Advanced Features"
          description="Go deeper with advanced capabilities."
          features={capabilityGroups[1].map(formatFeature)}
          image={tool.data.secondaryImage || tool.data.productImage}
          imageAlt={`${tool.data.name} advanced features`}
          icon={icons.advisor}
          iconColor="blue"
          imagePosition="right"
          background="gray"
          showBrowserFrame={true}
          testId={`${tool.slug}-capabilities-2`}
        />
      )}
    </section>

    <!-- Content Section (from MDX) -->
    <section class="py-16 bg-white" data-testid="tool-content-section">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
          <div class="prose prose-lg max-w-none prose-headings:text-gray-900 prose-p:text-gray-600 prose-strong:text-gray-900 prose-li:text-gray-600" data-testid="tool-content">
            <Content />
          </div>
        </div>
      </div>
    </section>

    <!-- Tech Specs Section -->
    <section id="specs">
      <TechSpecs
        client:load
        title="Technical Details"
        description={`Everything you need to know about ${tool.data.name}.`}
        icon={categoryIcon}
        iconColor={colorScheme}
        specs={techSpecs}
        columns={2}
        background="gray"
        docsLink={tool.data.docsLink}
        docsLinkText="View full documentation"
        testId={`${tool.slug}-specs`}
      />
    </section>

    <!-- Related Resources Section -->
    <section id="resources">
      <RelatedContent
        client:load
        title={`Learn More About ${tool.data.name}`}
        description="Explore related tools and documentation."
        journeys={journeys}
        docs={docs}
        background="white"
        ctaLink="/tools"
        ctaText="Browse all tools"
        testId={`${tool.slug}-resources`}
      />
    </section>

    <!-- CTA Section -->
    <section class="py-16 bg-gradient-to-r from-violet-600 to-blue-600" data-testid="tool-cta-section">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-3xl font-bold text-white mb-4" data-testid="tool-cta-title">
          Get Full Access to All Tools
        </h2>
        <p class="text-xl text-white/80 mb-8 max-w-2xl mx-auto" data-testid="tool-cta-description">
          Access {tool.data.name} plus 7 other tools, Sources, Lab, Studio, and more with a one-time purchase.
        </p>
        <div class="flex flex-wrap justify-center gap-4">
          <a
            href="/#pricing"
            class="inline-flex items-center px-8 py-4 bg-white text-violet-600 font-semibold rounded-xl hover:bg-gray-100 transition-colors"
            data-testid="tool-cta-button"
          >
            Get Lattice for $99
          </a>
          <a
            href="/tools"
            class="inline-flex items-center px-8 py-4 bg-white/10 text-white font-semibold rounded-xl hover:bg-white/20 transition-colors"
            data-testid="tool-browse-button"
          >
            Browse All Tools
          </a>
        </div>
      </div>
    </section>
  </main>

  <Footer client:load />
</Layout>
